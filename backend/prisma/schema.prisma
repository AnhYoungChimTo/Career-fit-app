// Prisma schema for Career Fit Analysis

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id                  String      @id @default(uuid())
  email               String      @unique
  passwordHash        String
  name                String?
  headline            String?
  location            String?
  phoneNumber         String?
  linkedinUrl         String?
  about               String?
  currentRole         String?
  currentCompany      String?
  securityQuestion    String
  securityAnswerHash  String
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  interviews          Interview[]
  profile             UserProfile?

  @@index([email])
}

// Interview model with interviewType field
model Interview {
  id                String    @id @default(uuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Interview type: lite, deep, or lite_upgraded
  interviewType     String    @default("deep") // 'lite' | 'deep' | 'lite_upgraded'

  // Interview status
  status            String    @default("in_progress") // 'in_progress' | 'completed' | 'abandoned'
  currentModule     String?   // 'A', 'B', 'C', ... 'L' or 'skills', 'values', 'situation'
  currentQuestion   Int?      // Question number within module

  // Timestamps
  startedAt         DateTime  @default(now())
  completedAt       DateTime?
  lastActivityAt    DateTime  @updatedAt

  // A1: Personality Data (JSON)
  // Stores: MBTI, Big Five, Work Style, EQ, Motivation, Stress Management
  personalityData   Json?

  // A2: Talents Data (JSON)
  // Stores: Cognitive abilities, Physical skills, Interpersonal skills, Learning agility
  talentsData       Json?

  // A3: Values Data (JSON)
  // Stores: Work-life balance, Impact vs Money, Stability, Ethics, Vision
  valuesData        Json?

  // Session data (all answers stored here)
  sessionData       Json?     // { completed_modules: [], answers: {module: {questionId: answer}} }

  results           Result[]

  @@index([userId])
  @@index([status])
  @@index([interviewType])
}

// Result model
model Result {
  id            String    @id @default(uuid())
  interviewId   String
  interview     Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  // A Score (Personal Attributes) - 0 to 100
  aScore        Float     @default(0)
  a1Score       Float     @default(0) // Personality score
  a2Score       Float     @default(0) // Talents score
  a3Score       Float     @default(0) // Values score

  // Confidence level based on data completeness
  confidenceLevel String  @default("medium") // 'low' | 'medium' | 'high'

  // Career Matches (JSON array)
  // Format: [{careerName, fitScore, reasons: [], gaps: [], roadmap: {}}]
  careerMatches Json

  // Top Recommendation
  topCareer     String
  topFitScore   Float

  generatedAt   DateTime  @default(now())

  @@index([interviewId])
}

// Career model
model Career {
  id                String   @id @default(uuid())
  name              String   @unique
  vietnameseName    String
  description       String

  // Category/Industry classification
  category          String   @default("general") // 'marketing', 'finance', 'international-relations', 'technology', 'creative', etc.

  // Requirements (JSON)
  // Format: { a1: {trait1: value, trait2: value}, a2: {...}, a3: {...} }
  requirements      Json

  // Metadata
  avgSalaryVND      String?
  workHoursPerWeek  Int?
  stressLevel       String?  // 'low' | 'moderate' | 'high' | 'very_high'
  growthPotential   String?  // 'low' | 'moderate' | 'high' | 'very_high'

  // Cached GPT-4o Analysis (Job Card) - Saves API tokens
  // Format: { detailedAnalysis, careerPattern, salaryInfo, skillStack, learningPlan }
  cachedAnalysis    Json?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([name])
  @@index([category])
}

// ===== USER PROFILE SYSTEM =====

// User Profile (extended profile info beyond basic User model)
model UserProfile {
  id                String   @id @default(uuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic Info
  firstName         String
  lastName          String
  profilePhoto      String?
  headline          String?
  location          String?
  bio               String?

  // Social Links
  linkedIn          String?
  github            String?
  portfolioUrl      String?
  twitter           String?

  // Privacy
  visibility        String   @default("public") // public, employers_only, private

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  skills            Skill[]
  experiences       Experience[]
  educationRecords  Education[]
  portfolioItems    PortfolioItem[]

  @@index([userId])
}

// Skills
model Skill {
  id              String      @id @default(uuid())
  profileId       String
  profile         UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  name            String
  level           String      // beginner, intermediate, advanced, expert
  verified        Boolean     @default(false)

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@unique([profileId, name])
  @@index([profileId])
}

// Work Experience
model Experience {
  id              String      @id @default(uuid())
  profileId       String
  profile         UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  title           String
  company         String
  location        String?
  startDate       DateTime
  endDate         DateTime?
  current         Boolean     @default(false)
  description     String

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([profileId])
}

// Education
model Education {
  id              String      @id @default(uuid())
  profileId       String
  profile         UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  degree          String
  institution     String
  major           String?
  graduationYear  String
  description     String?

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([profileId])
}

// Portfolio Items
model PortfolioItem {
  id              String      @id @default(uuid())
  profileId       String
  profile         UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  title           String
  description     String
  type            String      // project, certificate, publication, award
  url             String?
  imageUrl        String?
  skills          Json        @default("[]") // Array of skill names
  startDate       DateTime?
  endDate         DateTime?

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([profileId])
  @@index([type])
}
